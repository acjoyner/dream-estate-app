<div class="min-h-screen flex flex-col">
  <header class="bg-white shadow-md p-4 flex justify-between items-center sticky top-0 z-30">
    <h1 class="text-3xl font-extrabold text-blue-700 tracking-tight">
      {{ title }}
    </h1>
    <nav>
      <ul class="flex space-x-6 items-center">
        <!-- Use a local template variable for async pipe result -->
        <ng-container *ngIf="firebaseService.userId$ | async as currentUserIdObservable">
          <li *ngIf="currentUserIdObservable">
            <button mat-button
              [class.text-blue-600]="activeView === 'upload'"
              [class.border-b-2]="activeView === 'upload'"
              [class.border-blue-600]="activeView === 'upload'"
              [class.text-gray-600]="activeView !== 'upload'"
              [class.hover:text-blue-500]="activeView !== 'upload'"
              class="text-lg font-medium transition-colors duration-200"
              (click)="changeView('upload')"
            >
              Upload Media
            </button>
          </li>
          <li *ngIf="currentUserIdObservable">
            <button mat-button
              [class.text-blue-600]="activeView === 'display'"
              [class.border-b-2]="activeView === 'display'"
              [class.border-blue-600]="activeView === 'display'"
              [class.text-gray-600]="activeView !== 'display'"
              [class.hover:text-blue-500]="activeView !== 'display'"
              class="text-lg font-medium transition-colors duration-200"
              (click)="changeView('display')"
            >
              View Media
            </button>
          </li>
          <li *ngIf="currentUserIdObservable">
            <button mat-button
              [class.text-blue-600]="activeView === 'profile'"
              [class.border-b-2]="activeView === 'profile'"
              [class.border-blue-600]="activeView === 'profile'"
              [class.text-gray-600]="activeView !== 'profile'"
              [class.hover:text-blue-500]="activeView !== 'profile'"
              class="text-lg font-medium transition-colors duration-200"
              (click)="changeView('profile')"
            >
              Profile
            </button>
          </li>
          <li *ngIf="currentUserIdObservable">
            <button mat-button
              [class.text-blue-600]="activeView === 'friends'"
              [class.border-b-2]="activeView === 'friends'"
              [class.border-blue-600]="activeView === 'friends'"
              [class.text-gray-600]="activeView !== 'friends'"
              [class.hover:text-blue-500]="activeView !== 'friends'"
              class="text-lg font-medium transition-colors duration-200"
              (click)="changeView('friends')"
            >
              Friends
            </button>
          </li>
          <!-- Now using currentUserIdObservable and isAdmin -->
          <li *ngIf="currentUserIdObservable && isAdmin">
            <button mat-button
              [class.text-blue-600]="activeView === 'admin'"
              [class.border-b-2]="activeView === 'admin'"
              [class.border-blue-600]="activeView === 'admin'"
              [class.text-gray-600]="activeView !== 'admin'"
              [class.hover:text-blue-500]="activeView !== 'admin'"
              class="text-lg font-medium transition-colors duration-200"
              (click)="changeView('admin')"
            >
              Admin Panel
            </button>
          </li>
          <li *ngIf="currentUserIdObservable">
            <button mat-flat-button color="warn" (click)="onLogout()"
                    class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-md shadow-md transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-opacity-75">
              Logout
            </button>
          </li>
          <li *ngIf="userProfilePictureUrl" class="ml-4">
            <img [src]="userProfilePictureUrl" alt="Profile" class="w-8 h-8 rounded-full object-cover border border-gray-300 shadow-sm">
          </li>
          <li *ngIf="isAdmin" class="ml-2 text-sm text-purple-700 font-bold">ADMIN</li>
        </ng-container>

        <!-- Login/Signup buttons (only show if NOT logged in) -->
        <ng-container *ngIf="!(firebaseService.userId$ | async)">
          <li>
            <button mat-button
              [class.text-blue-600]="activeView === 'login'"
              [class.border-b-2]="activeView === 'login'"
              [class.border-blue-600]="activeView === 'login'"
              [class.text-gray-600]="activeView !== 'login'"
              [class.hover:text-blue-500]="activeView !== 'login'"
              class="text-lg font-medium transition-colors duration-200"
              (click)="changeView('login')"
            >
              Login
            </button>
          </li>
          <li>
            <button mat-button
              [class.text-blue-600]="activeView === 'signup'"
              [class.border-b-2]="activeView === 'signup'"
              [class.border-blue-600]="activeView === 'signup'"
              [class.text-gray-600]="activeView !== 'signup'"
              [class.hover:text-blue-500]="activeView !== 'signup'"
              class="text-lg font-medium transition-colors duration-200"
              (click)="changeView('signup')"
            >
              Sign Up
            </button>
          </li>
        </ng-container>
      </ul>
    </nav>
  </header>

  <main class="flex-grow p-8">
    <div *ngIf="isServiceReady" class="text-center mb-6 text-gray-700 text-sm">
      <ng-container *ngIf="currentUserId; else notLoggedIn">
        Your User ID: <span class="font-mono bg-gray-200 px-2 py-1 rounded text-blue-800 break-all">{{ currentUserId }}</span>
      </ng-container>
      <ng-template #notLoggedIn>
        <span class="text-gray-600">Please Login or Sign Up</span>
      </ng-template>
      <br>
      <span class="italic text-gray-500">
        (Data will now persist with Firebase!)
      </span>
    </div>
    <div *ngIf="!isServiceReady" class="text-center text-gray-600 mb-6">
      Initializing App... Please wait.
    </div>
    <!-- Conditional rendering based on authentication state and active view -->
    <ng-container *ngIf="firebaseService.userId$ | async as currentUserIdMain; else authSection">
      <app-media-upload *ngIf="activeView === 'upload'"></app-media-upload>
      <app-media-display *ngIf="activeView === 'display'"></app-media-display>
      <app-profile *ngIf="activeView === 'profile'"></app-profile>
      <app-friends *ngIf="activeView === 'friends'"></app-friends>
      <app-admin-panel *ngIf="activeView === 'admin' && isAdmin"></app-admin-panel> <!-- Use isAdmin directly -->
    </ng-container>

    <ng-template #authSection>
      <app-login *ngIf="activeView === 'login'"></app-login>
      <app-signup *ngIf="activeView === 'signup'"></app-signup>
    </ng-template>
  </main>
</div>