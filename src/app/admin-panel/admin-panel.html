<div class="container mx-auto p-4" >
  <app-message-box *ngIf="showMessageBox" [message]="message" (onClose)="closeMessageBox()"></app-message-box>

  <h2 class="text-3xl font-bold text-center text-gray-800 mb-6">Admin Panel</h2>

  <div *ngIf="!isAdmin" class="text-center text-red-600 mb-6">
    Access Denied. You must be an administrator to view this page.
  </div>

  <div *ngIf="isAdmin">
    <div *ngIf="isLoading" class="text-center text-gray-600 mb-6">Loading all users...</div>

    <mat-card *ngIf="!isLoading && allUsers.length > 0" class="p-6 rounded-xl mat-card">
      <mat-card-title class="text-xl font-semibold mb-4">All Registered Users ({{ allUsers.length }})</mat-card-title>
      <mat-card-content>
        <p class="text-sm text-gray-600 mb-4">
          Note: Deleting users (from Auth) typically requires Firebase Cloud Functions for security.
          Role changes update Firestore directly.
        </p>

        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
          <!-- FIX: Add trackBy: trackByUid to the *ngFor loop -->
          <mat-card *ngFor="let user of allUsers; trackBy: trackByUid" class="flex flex-col items-center p-4 rounded-lg mat-card shadow-sm">
            <img [src]="user.profilePictureUrl || 'https://placehold.co/60x60/ccc/fff?text=?'" alt="Profile" class="w-16 h-16 rounded-full mb-3 object-cover border border-gray-200 rounded-md">

            <span class="text-lg font-medium text-gray-800 text-center">{{ user.displayName }}</span>
            <span class="text-sm text-gray-500 mb-1 text-center">{{ user.email }}</span>
            <p class="text-xs text-gray-500 mb-3">UID: {{ user.uid.substring(0, 8) + '...' }}</p>

            <div class="w-full flex flex-col items-center space-y-2 mt-auto">
              <span class="text-sm font-semibold mb-2">Role: <span [ngClass]="{'font-bold text-purple-700': user.role === 'admin'}">{{ user.role }}</span></span>

              <button mat-flat-button color="accent" (click)="changeUserRole(user.uid, user.role === 'admin' ? 'user' : 'admin')"
                      class="w-full text-xs px-2 py-1">
                {{ user.role === 'admin' ? 'Demote to User' : 'Promote to Admin' }}
              </button>
              <button mat-stroked-button color="warn" (click)="deleteUserAsAdmin(user.uid, user.email)"
                      class="w-full text-xs px-2 py-1">
                Delete User (CF)
              </button>
            </div>
          </mat-card>
        </div>
      </mat-card-content>
    </mat-card>

    <div *ngIf="!isLoading && allUsers.length === 0" class="text-center text-gray-600 mt-8">
      No users registered yet.
    </div>
  </div>
</div>